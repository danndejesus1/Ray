<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarGo Admin Dashboard</title>
    <meta name="theme-color" content="#34B2DF">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Outfit:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../assets/css/main.css">
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="navbar bg-white shadow-md">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <a href="../../index.html" class="text-2xl font-bold text-gray-800">CarGo</a>
                    <span class="text-gray-500">|</span>
                    <span class="text-lg font-semibold text-blue-600">Admin Dashboard</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="admin-welcome" class="text-gray-600">Welcome, Admin</span>
                    <button id="logout-btn" class="btn btn-secondary">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="flex">
        <!-- Sidebar -->
        <div class="w-64 bg-white shadow-lg min-h-screen">
            <div class="p-6">
                <nav class="space-y-2">
                    <a href="#dashboard" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg bg-blue-50 text-blue-600 font-medium">
                        <span>ðŸ“Š</span>
                        <span>Dashboard</span>
                    </a>
                    <a href="#vehicles" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50">
                        <span>ðŸš—</span>
                        <span>Vehicle Management</span>
                    </a>
                    <a href="#bookings" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50">
                        <span>ðŸ“‹</span>
                        <span>Booking Management</span>
                    </a>
                    <a href="#users" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50">
                        <span>ðŸ‘¥</span>
                        <span>User Management</span>
                    </a>
                    <a href="#reports" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50">
                        <span>ðŸ“ˆ</span>
                        <span>Reports</span>
                    </a>
                    <a href="#payments" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50">
                        <span>ðŸ’³</span>
                        <span>Payments</span>
                    </a>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-6">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="section">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Business Analytics Dashboard</h1>
                    <div class="flex space-x-2">
                        <button id="refresh-analytics" class="btn btn-secondary">
                            ðŸ”„ Refresh
                        </button>
                        <select id="analytics-period" class="form-input">
                            <option value="weekly">Weekly</option>
                            <option value="monthly" selected>Monthly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                </div>

                <!-- Dashboard Stats -->
                <div id="dashboard-stats" class="mb-8">
                    <!-- Stats will be populated by JavaScript -->
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div id="booking-trends-chart">
                        <!-- Booking trends chart -->
                    </div>
                    <div id="vehicle-type-chart">
                        <!-- Vehicle type chart -->
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div id="revenue-chart">
                        <!-- Revenue breakdown chart -->
                    </div>
                    <div id="popular-vehicles-table">
                        <!-- Popular vehicles table -->
                    </div>
                </div>
            </div>

            <!-- Vehicle Management Section -->
            <div id="vehicles-section" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Vehicle Management</h1>
                    <button id="add-vehicle-btn" class="btn btn-primary">
                        âž• Add Vehicle
                    </button>
                </div>

                <!-- Vehicle Filters -->
                <div class="card mb-6">
                    <h3 class="text-lg font-semibold mb-4">Filter Vehicles</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <select id="admin-brand-filter" class="form-input">
                            <option value="">All Brands</option>
                            <option value="Toyota">Toyota</option>
                            <option value="Honda">Honda</option>
                            <option value="Mitsubishi">Mitsubishi</option>
                        </select>
                        <select id="admin-type-filter" class="form-input">
                            <option value="">All Types</option>
                            <option value="Sedan">Sedan</option>
                            <option value="SUV">SUV</option>
                            <option value="Van">Van</option>
                        </select>
                        <select id="admin-status-filter" class="form-input">
                            <option value="">All Status</option>
                            <option value="available">Available</option>
                            <option value="booked">Booked</option>
                            <option value="maintenance">Maintenance</option>
                        </select>
                        <button id="apply-vehicle-filter" class="btn btn-primary">Apply Filter</button>
                    </div>
                </div>

                <!-- Vehicle List -->
                <div id="admin-vehicle-list" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                    <!-- Vehicle cards will be populated here -->
                </div>
            </div>

            <!-- Booking Management Section -->
            <div id="bookings-section" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Booking Management</h1>
                    <div class="flex space-x-2">
                        <select id="booking-status-filter" class="form-input">
                            <option value="">All Bookings</option>
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                        <button id="export-bookings" class="btn btn-secondary">ðŸ“Š Export</button>
                    </div>
                </div>

                <div class="card">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4">Booking ID</th>
                                    <th class="text-left py-3 px-4">Customer</th>
                                    <th class="text-left py-3 px-4">Vehicle</th>
                                    <th class="text-left py-3 px-4">Dates</th>
                                    <th class="text-left py-3 px-4">Status</th>
                                    <th class="text-left py-3 px-4">Total</th>
                                    <th class="text-left py-3 px-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-bookings-table">
                                <!-- Booking rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reports-section" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Reports</h1>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card">
                        <h3 class="text-lg font-semibold mb-4">Generate Report</h3>
                        <form id="report-form" class="space-y-4">
                            <div>
                                <label class="form-label">Report Type</label>
                                <select name="reportType" class="form-input">
                                    <option value="bookings">Booking Report</option>
                                    <option value="revenue">Revenue Report</option>
                                    <option value="vehicles">Vehicle Usage Report</option>
                                    <option value="customers">Customer Report</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Period</label>
                                <select name="period" class="form-input">
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Format</label>
                                <select name="format" class="form-input">
                                    <option value="html">HTML</option>
                                    <option value="csv">CSV</option>
                                    <option value="json">JSON</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary w-full">Generate Report</button>
                        </form>
                    </div>

                    <div class="card">
                        <h3 class="text-lg font-semibold mb-4">Recent Reports</h3>
                        <div id="recent-reports" class="space-y-3">
                            <!-- Recent reports will be listed here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payments Section -->
            <div id="payments-section" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Payment Transactions</h1>
                    <button id="export-payments" class="btn btn-secondary">ðŸ“Š Export</button>
                </div>

                <div class="card">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4">Transaction ID</th>
                                    <th class="text-left py-3 px-4">Booking ID</th>
                                    <th class="text-left py-3 px-4">Customer</th>
                                    <th class="text-left py-3 px-4">Amount</th>
                                    <th class="text-left py-3 px-4">Method</th>
                                    <th class="text-left py-3 px-4">Status</th>
                                    <th class="text-left py-3 px-4">Date</th>
                                </tr>
                            </thead>
                            <tbody id="admin-payments-table">
                                <!-- Payment rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Vehicle Modal -->
    <div id="add-vehicle-modal" class="modal-overlay hidden">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Add New Vehicle</h2>
                <button id="close-add-vehicle" class="text-gray-500 hover:text-gray-700 text-3xl">&times;</button>
            </div>
            <form id="add-vehicle-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Vehicle Name</label>
                        <input type="text" name="name" required class="form-input">
                    </div>
                    <div>
                        <label class="form-label">Brand</label>
                        <select name="brand" required class="form-input">
                            <option value="">Select Brand</option>
                            <option value="Toyota">Toyota</option>
                            <option value="Honda">Honda</option>
                            <option value="Mitsubishi">Mitsubishi</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Vehicle Type</label>
                        <select name="type" required class="form-input">
                            <option value="">Select Type</option>
                            <option value="Sedan">Sedan</option>
                            <option value="SUV">SUV</option>
                            <option value="Van">Van</option>
                            <option value="Hatchback">Hatchback</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Fuel Type</label>
                        <select name="fuelType" required class="form-input">
                            <option value="">Select Fuel Type</option>
                            <option value="Petrol">Petrol</option>
                            <option value="Diesel">Diesel</option>
                            <option value="Hybrid">Hybrid</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Seating Capacity</label>
                        <select name="capacity" required class="form-input">
                            <option value="">Select Capacity</option>
                            <option value="2">2</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Price per Day (â‚±)</label>
                        <input type="number" name="pricePerDay" required class="form-input" min="500">
                    </div>
                    <div>
                        <label class="form-label">Driving Option</label>
                        <select name="drivingOption" required class="form-input">
                            <option value="Self Drive">Self Drive</option>
                            <option value="With Driver">With Driver</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Image URL</label>
                        <input type="url" name="image" class="form-input">
                    </div>
                </div>
                <div>
                    <label class="form-label">Features (comma-separated)</label>
                    <input type="text" name="features" class="form-input" placeholder="Air Conditioning, GPS, Bluetooth">
                </div>
                <button type="submit" class="btn btn-primary w-full">Add Vehicle</button>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../config/app.config.js"></script>
    <script src="../../components/auth/auth.js"></script>
    <script src="../../components/vehicle/vehicle.js"></script>
    <script src="../../modules/analytics/analytics.js"></script>
    
    <script>
        // Admin Dashboard Implementation
        class AdminDashboard {
            constructor() {
                this.currentSection = 'dashboard';
                this.init();
            }

            init() {
                this.checkAuthentication();
                this.bindEvents();
                this.showSection('dashboard');
                this.loadDashboardData();
            }

            checkAuthentication() {
                if (!AuthManager.isAuthenticated() || !AuthManager.hasRole('admin')) {
                    window.location.href = '../../index.html';
                    return;
                }
                
                const user = AuthManager.getCurrentUser();
                if (user) {
                    document.getElementById('admin-welcome').textContent = `Welcome, ${user.name}`;
                }
            }

            bindEvents() {
                // Navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = e.currentTarget.getAttribute('href').substring(1);
                        this.showSection(section);
                    });
                });

                // Logout
                document.getElementById('logout-btn').addEventListener('click', () => {
                    AuthManager.logout();
                });

                // Add vehicle modal
                document.getElementById('add-vehicle-btn').addEventListener('click', () => {
                    document.getElementById('add-vehicle-modal').classList.remove('hidden');
                });

                document.getElementById('close-add-vehicle').addEventListener('click', () => {
                    document.getElementById('add-vehicle-modal').classList.add('hidden');
                });

                // Add vehicle form
                document.getElementById('add-vehicle-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleAddVehicle(e.target);
                });

                // Report generation
                document.getElementById('report-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.generateReport(e.target);
                });
            }

            showSection(sectionName) {
                // Hide all sections
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.add('hidden');
                });

                // Update navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('bg-blue-50', 'text-blue-600', 'font-medium');
                    item.classList.add('text-gray-600');
                });

                // Show selected section
                const targetSection = document.getElementById(`${sectionName}-section`);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                }

                // Update navigation active state
                const activeNav = document.querySelector(`[href="#${sectionName}"]`);
                if (activeNav) {
                    activeNav.classList.remove('text-gray-600');
                    activeNav.classList.add('bg-blue-50', 'text-blue-600', 'font-medium');
                }

                this.currentSection = sectionName;
                this.loadSectionData(sectionName);
            }

            loadSectionData(sectionName) {
                switch (sectionName) {
                    case 'dashboard':
                        this.loadDashboardData();
                        break;
                    case 'vehicles':
                        this.loadVehicleData();
                        break;
                    case 'bookings':
                        this.loadBookingData();
                        break;
                    case 'payments':
                        this.loadPaymentData();
                        break;
                }
            }

            loadDashboardData() {
                if (window.AnalyticsManager) {
                    AnalyticsManager.renderDashboard();
                }
            }

            loadVehicleData() {
                // Load vehicles for admin management
                const vehicles = VehicleManager.vehicles || [];
                this.renderAdminVehicles(vehicles);
            }

            renderAdminVehicles(vehicles) {
                const container = document.getElementById('admin-vehicle-list');
                if (!container) return;

                container.innerHTML = vehicles.map(vehicle => `
                    <div class="card">
                        <img src="${vehicle.image}" alt="${vehicle.name}" class="w-full h-48 object-cover rounded-lg mb-4">
                        <h3 class="font-semibold text-lg mb-2">${vehicle.name}</h3>
                        <p class="text-gray-600 text-sm mb-2">${vehicle.brand} - ${vehicle.type}</p>
                        <p class="text-gray-600 text-sm mb-4">â‚±${vehicle.pricePerDay}/day</p>
                        <div class="flex space-x-2">
                            <button onclick="adminDashboard.editVehicle('${vehicle.id}')" class="btn btn-secondary flex-1">Edit</button>
                            <button onclick="adminDashboard.deleteVehicle('${vehicle.id}')" class="btn btn-error flex-1">Delete</button>
                        </div>
                    </div>
                `).join('');
            }

            loadBookingData() {
                // Mock booking data
                const bookings = [
                    {
                        id: 'BK001',
                        customer: 'John Doe',
                        vehicle: 'Toyota Vios',
                        dates: 'Jun 21 - Jun 23',
                        status: 'confirmed',
                        total: 'â‚±4,500'
                    }
                ];

                this.renderAdminBookings(bookings);
            }

            renderAdminBookings(bookings) {
                const tbody = document.getElementById('admin-bookings-table');
                if (!tbody) return;

                tbody.innerHTML = bookings.map(booking => `
                    <tr class="border-b border-gray-100">
                        <td class="py-3 px-4">${booking.id}</td>
                        <td class="py-3 px-4">${booking.customer}</td>
                        <td class="py-3 px-4">${booking.vehicle}</td>
                        <td class="py-3 px-4">${booking.dates}</td>
                        <td class="py-3 px-4">
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">${booking.status}</span>
                        </td>
                        <td class="py-3 px-4">${booking.total}</td>
                        <td class="py-3 px-4">
                            <button class="text-blue-600 hover:underline text-sm">View</button>
                        </td>
                    </tr>
                `).join('');
            }

            loadPaymentData() {
                // Mock payment data
                const payments = [
                    {
                        transactionId: 'TXN001',
                        bookingId: 'BK001',
                        customer: 'John Doe',
                        amount: 'â‚±4,500',
                        method: 'QR Code',
                        status: 'completed',
                        date: '2025-06-21'
                    }
                ];

                this.renderAdminPayments(payments);
            }

            renderAdminPayments(payments) {
                const tbody = document.getElementById('admin-payments-table');
                if (!tbody) return;

                tbody.innerHTML = payments.map(payment => `
                    <tr class="border-b border-gray-100">
                        <td class="py-3 px-4">${payment.transactionId}</td>
                        <td class="py-3 px-4">${payment.bookingId}</td>
                        <td class="py-3 px-4">${payment.customer}</td>
                        <td class="py-3 px-4">${payment.amount}</td>
                        <td class="py-3 px-4">${payment.method}</td>
                        <td class="py-3 px-4">
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">${payment.status}</span>
                        </td>
                        <td class="py-3 px-4">${payment.date}</td>
                    </tr>
                `).join('');
            }

            async handleAddVehicle(form) {
                const formData = new FormData(form);
                const vehicleData = {
                    name: formData.get('name'),
                    brand: formData.get('brand'),
                    type: formData.get('type'),
                    fuelType: formData.get('fuelType'),
                    capacity: parseInt(formData.get('capacity')),
                    pricePerDay: parseInt(formData.get('pricePerDay')),
                    drivingOption: formData.get('drivingOption'),
                    image: formData.get('image') || 'https://via.placeholder.com/400x300',
                    features: formData.get('features').split(',').map(f => f.trim()).filter(f => f),
                    available: true,
                    location: 'Metro Manila'
                };

                const result = await VehicleManager.addVehicle(vehicleData);
                
                if (result.success) {
                    alert('Vehicle added successfully!');
                    document.getElementById('add-vehicle-modal').classList.add('hidden');
                    form.reset();
                    this.loadVehicleData();
                } else {
                    alert('Failed to add vehicle: ' + result.message);
                }
            }

            generateReport(form) {
                const formData = new FormData(form);
                const reportType = formData.get('reportType');
                const period = formData.get('period');
                const format = formData.get('format');

                if (window.AnalyticsManager) {
                    AnalyticsManager.exportReport(format, period);
                } else {
                    alert('Analytics module not available');
                }
            }

            editVehicle(vehicleId) {
                // Implement vehicle editing
                alert('Edit vehicle feature coming soon');
            }

            async deleteVehicle(vehicleId) {
                if (confirm('Are you sure you want to delete this vehicle?')) {
                    const result = await VehicleManager.deleteVehicle(vehicleId);
                    if (result.success) {
                        alert('Vehicle deleted successfully');
                        this.loadVehicleData();
                    } else {
                        alert('Failed to delete vehicle: ' + result.message);
                    }
                }
            }
        }

        // Initialize admin dashboard
        const adminDashboard = new AdminDashboard();
    </script>
</body>
</html>
